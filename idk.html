<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meme Maker</title>
</head>
<body>

<h1>Meme Maker</h1>

<div>
    <label for="imageInput">Choose Image File:</label>
    <input type="file" id="imageInput">
</div>

<div>
    <label for="topText">Top Text:</label>
    <input type="text" id="topText" placeholder="Enter top text">
</div>

<div>
    <label for="bottomText">Bottom Text:</label>
    <input type="text" id="bottomText" placeholder="Enter bottom text">
</div>

<button onclick="makeMeme()">Generate Meme</button>

<div id="result"></div>
<div class="container">
    <div class="bottom-half">
        <h1 class="p1"><strong>Meme Result</strong></h1>
        <img id="uploadedImage" src="" alt="Uploaded Image" style="max-width: 100%; display: none;">
        <br>
        <button id="downloadButton" class="button">Download Meme</button>
        <br>
    </div>
</div>


<script>
    const options = {
        method: 'GET', // *GET, POST, PUT, DELETE, etc.
        mode: 'cors', // no-cors, *cors, same-origin
        cache: 'default', // *default, no-cache, reload, force-cache, only-if-cached
        credentials: 'omit', // include, *same-origin, omit
        headers: {
            'Content-Type': 'application/json',
            // 'Content-Type': 'application/x-www-form-urlencoded',
        },
    };
    const post_options = {
        method: 'POST', // *GET, POST, PUT, DELETE, etc.
        mode: 'cors', // no-cors, *cors, same-origin
        cache: 'default', // *default, no-cache, reload, force-cache, only-if-cached
        credentials: 'omit', // include, *same-origin, omit
        headers: {
            'Content-Type': 'application/json',
            // 'Content-Type': 'application/x-www-form-urlencoded',
        },
    };
    
    const url = "http://localhost:8762/api/memeforge/maker";

    function makeMeme() {
        const imageInput = document.getElementById('imageInput');
        const topText = document.getElementById('topText').value;
        const bottomText = document.getElementById('bottomText').value;
        const uploadedImage = document.getElementById('uploadedImage');
        
        
        const file = imageInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);

            // Set up the onloadend event handler
            reader.onload = function (e) {
                // Base64-encoded image data
                const base64image = e.target.result.split(',')[1];
                const filename = file.name;
                const fileExtension = filename.split('.').pop();
                const data = {
                    base64image: base64image,
                    top_text: topText,
                    bottom_text: bottomText,
                    addToHistory: true,
                    filename: filename,
                };
                console.log(data)

                const image_options = {...post_options, method: 'POST', body: JSON.stringify(data)};
    
                // Make a POST request to the Flask API endpoint
                fetch(url, image_options )
                .then(response => {
                    if (!response.status !=200) {
                        error('Api error: ' + response.status);
                        return;
                    }
                    respone.json().then(data => {
                        console.log(data)
                        const memeImage = new Image();
                        memeImage.src = 'data:image/' + fileExtension + ';base64,'+ data['base64image'];

                        memeImage.style.maxHeight = '100%';

                        uploadedImage.src = memeImage.src;
                        uploadedImage.style.display = 'block';

                        memeImage.onload = function(){
                            const parent = document.querySelector('.bottom-half');
                            const ratio = parent.clientWidth / memeImage.width;

                            if (ratio < 1){
                                const maxHeight = ratio * memeImage.height
                                parent.style.height = (maxHeight + 175) + 'px';
                            } else {
                                parent.style.height = (memeImage.height + 175) + 'px';

                            }
                        }
                    })
                })
        
    }
}
    }
    

    
</script>

</body>
</html>
